# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: zavastore
metadata:
  template: zavastore-web-app

infra:
  provider: bicep
  path: infra
  parameters:
    azureLocation: westus3

services:
  web:
    project: ./src
    language: csharp
    host: appservice
    docker:
      path: ./Dockerfile
      context: ./src

hooks:
  postprovision:
    windows:
      shell: pwsh
      run: |
        Write-Host "Infrastructure provisioned successfully!"
        Write-Host "Building and pushing container image to ACR..."
        $acrName = azd env get-values --output json | ConvertFrom-Json | Select-Object -ExpandProperty ACR_NAME
        $imageName = "zavastore:latest"
        az acr build --registry $acrName --image $imageName --file ./src/Dockerfile ./src
        Write-Host "Container image built and pushed to ACR"
    posix:
      shell: sh
      run: |
        echo "Infrastructure provisioned successfully!"
        echo "Building and pushing container image to ACR..."
        acrName=$(azd env get-values --output json | jq -r '.ACR_NAME')
        imageName="zavastore:latest"
        az acr build --registry $acrName --image $imageName --file ./src/Dockerfile ./src
        echo "Container image built and pushed to ACR"

  predeploy:
    windows:
      shell: pwsh
      run: |
        Write-Host "Restarting Web App to pull latest image..."
        $webAppName = azd env get-values --output json | ConvertFrom-Json | Select-Object -ExpandProperty WEB_APP_NAME
        $rgName = azd env get-values --output json | ConvertFrom-Json | Select-Object -ExpandProperty RESOURCE_GROUP_NAME
        az webapp restart --name $webAppName --resource-group $rgName
    posix:
      shell: sh
      run: |
        echo "Restarting Web App to pull latest image..."
        webAppName=$(azd env get-values --output json | jq -r '.WEB_APP_NAME')
        rgName=$(azd env get-values --output json | jq -r '.RESOURCE_GROUP_NAME')
        az webapp restart --name $webAppName --resource-group $rgName
